조인
=
- 조인이란 하나의 테이블이 아닌 두 개이상의 테이블을 묶어서 하나의 결과물을 만드는 것을 말합니다.
- MySQL에서는 JOIN을 이용하고, MongoDB에서는 lookup이라는 쿼리로 이를 처리할 수 있습니다.
- MongoDB에서는 lookup을 최대한 사용하지 말아야 합니다. MongoDB에서의 조인 연산에 대해 관계형 데이터베이스보다 성능이 떨어집니다.
- 따라서 조인이 많은 경우 관계형 데이터베이스를 사용하는 것이 좋습니다.
- 조인의 종류
  - 조인의 종류에는 내부조인, 왼쪽 조인, 오른쪽 조인, 합집합 조인이 있습니다.
  - 내부조인 (inner join)
    - 왼쪽 테이블과 오른쪽 테이블의 두 행이 모두 일치한 행만을 표기
    - 두 테이블의 교집합을 나타냅니다.
    ```
    SELECT * FROM tablea A
    INNER JOIN tableb B ON
    A.key = B.key
    ```
  - 왼쪽 조인(left outer join) 
    - 왼쪽 테이블의 모든 행의 결과 테이블에 표기합니다.
    - 왼쪽 조인은 테이블 B의 일치하는 부분의 레코드와 함께 테이블 A를 기준으로 완전한 레코드 집합을 생성합니다.
    - 만약 테이블 B에 일치하는 항목이 없으면 해당 값은 null 값이 됩니다.
    ```
    SELECT * FROM tablea A
    LEFT JOIN tableb B ON
    A.key = B.key
    ```
  - 오른쪽 조인(right outer join)
    - 오른쪽 테이블의 모든 행이 결과 테이블에 표기 됩니다.
    - 왼쪽 조인과 반대로 테이블 B를 기준으로 완전한 레코드 집합을 생성합니다.
    - 만약 테이블 A에 일치하는 항목이 없다면 해당 값은 null 값이 됩니다.
    ```
    SELECT * FROM tablea A
    RIGHT JOIN tableb B ON
    A.key = B.key
    ```
  - 합집합 조인(full outer join)
    - 두 개의 테이블을 기반으로 조인 조건에 만족ㅎ하지 않는 행까지 모두 표기합니다.
    - 합집합 조인(완전 외부 조인)은 양쪽 테이블에서 일치하는 레코드와 함께 테이블 A와 테이블 B의 모든 레코드 집합을 생성합니다. 이때 일치하는 항목이 없으면 누락된 쪽에는 null 값이 포함되어 출력됩니다.
    ```
    SELECT * FROM tablea A
    FULL OUTER JOIN tableb B ON
    A.key = B.key
    ```
  - 조인의 원리
    - 조인 원리에는 중첩 루프 조인, 정렬 병합 조인, 해시 조인이 있습니다.
    - 중첩 루프 조인(NLJ, Nested Loop Join)
      - 중첩 루프 조인은 중첩 for 문과 같은 원리로 조건에 맞는 조인을 하는 방법이며, 랜덤 접근에 대한 비용이 많이 증가하므로 대용량의 테이블에서는 사용하지 않습니다.
      - 중첩 루프 조인에서 발전한 조인할 테이블을 작은 블록으로 나눠서 블록 하나씩 조인하는 블록 중첩 루프 조인(BNL, Block Nested Loop)라는 방식도 있습니다.
    ```
      의사 코드
      for each row in table1 matching reference key {
        for each row in table2 matching reference key {
          if row satisfies join conditions, send to client
        }
      }
    ```
    - 정렬 병합 조인
      - 정렬 병합 조인은 각각의 테이블을 조인할 필드 기준으로 정렬하고 정렬이 끝난 이후에 조인 작업을 수행하는 조인입니다.
      - 조인할 때 쓰일 인덱스가 없고 대용량의 테이블들을 조인하고 조인 조건으로 <,> 등 범위 비교 연산자가 있을 때 씁니다.
    - 해시 조인
      - 해시 조인은 해시 테이블을 기반으로 조인하는 방법입니다.
      - 두 개의 테이블을 조인한다고 했을 때 하나의 테이블이 메모리에 온전히 들어간다면 보통 중첩 루프 조인보다 더 효율적입니다. 단, 메모리에 올릴 수 없다면 디스크를 사용하는 비용이 발생합니다.
      - MySQL의 해시 조인 단계는 빌드 단계, 프로브 단계로 나뉩니다.
        - 빌드 단계
          - 빌드 단계는 입력 테이블 중 하나를 기반으로 메모리 내 해시 테이블을 빌드하는 단계입니다.
          - 예를 들면 t1과 t2테이블이 있을 때 메모리 둘 중에 바이트가 더 작은 테이블을 기반으로 해서 테이블을 빌드합니다.
        - 프로브 단계
          - 프로브 단계 동안 레코드 읽기를 시작합니다.
          - 각 테이블은 한 번씩만 읽게 되어 중첩해서 두 개의 테이블을 읽는 중첩 루프 조인보다 보통은 성능이 더 좋습니다.